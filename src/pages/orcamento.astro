---
import BaseLayout from '../layouts/BaseLayout.astro';
import Button from '../components/ui/Button.astro';
import { CONTACT } from '../utils/constants';

const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';
---

<BaseLayout 
  title="Solicitar Orçamento | RN Transportes e Mudanças"
  description="Solicite seu orçamento gratuito de mudança. Preencha o formulário e retornaremos em breve. RN Transportes - Belo Horizonte e todo o Brasil."
  canonical="https://rntransportesbh.com.br/orcamento"
  keywords="orçamento mudança, orçamento mudanças BH, RN Transportes orçamento"
  url="https://rntransportesbh.com.br/orcamento"
  loadTurnstile={!!TURNSTILE_SITE_KEY}
>
  <!-- 1. Primeira seção: imagem de fundo – padrão contato -->
  <section
    class="relative pt-24 pb-16 md:pt-28 md:pb-20 min-h-[640px] md:min-h-[720px] flex items-center bg-cover bg-no-repeat bg-center"
    style="background-image: url('/assets/carousel/carousel-1.png');"
  >
    <div class="absolute inset-0 bg-gradient-to-r from-[var(--color-dark-blue)]/92 via-[var(--color-dark-blue)]/70 to-[var(--color-dark-blue)]/35" aria-hidden="true"></div>
    <div class="section-shapes absolute inset-0 pointer-events-none hidden md:block z-0" aria-hidden="true">
      <div class="absolute left-[2%] top-[18%] w-7 h-7 bg-[var(--color-yellow)] opacity-50 rotate-12"></div>
      <div class="absolute left-[1.5%] bottom-[22%] w-6 h-10 bg-[var(--color-cyan)] opacity-45 -rotate-6"></div>
      <div class="absolute right-[2%] top-[28%] w-6 h-6 bg-[var(--color-cyan)] opacity-50 -rotate-12"></div>
      <div class="absolute right-[1.5%] bottom-[18%] w-8 h-6 bg-[var(--color-yellow)] opacity-55 rotate-6"></div>
    </div>
    <div class="container relative z-10 mx-auto px-6 w-full max-w-xl">
      <div class="text-center mb-8">
        <a href="/" class="inline-block mb-6 hover:opacity-90 transition-opacity">
          <img src="/assets/logos/logo-rn-transportes.png" alt="RN Transportes e Mudanças" class="h-10 md:h-12 w-auto mx-auto" width="180" height="48" />
        </a>
        <h1 class="text-3xl md:text-4xl font-bold mb-4 text-white">
          Faça um orçamento gratuito
        </h1>
        <p class="text-white/95 text-lg">
          Preencha o formulário e solicite seu orçamento. Retornaremos em breve.
        </p>
      </div>

      <div class="form-card-orcamento bg-white rounded-xl p-6 md:p-8 border border-gray-200 shadow-2xl">
        <form id="contact-form" class="space-y-5" novalidate>
          <!-- Honeypot: invisível para usuários, preenchido por bots -->
          <div class="absolute -left-[9999px] w-px h-px overflow-hidden opacity-0" aria-hidden="true">
            <input type="text" name="company_website" autocomplete="off" tabindex="-1" />
          </div>

          <div>
            <label for="name" class="block text-gray-800 mb-2 font-medium">
              Nome completo <span class="text-red-600">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--color-bondi-blue)] focus:border-transparent"
              placeholder="Seu nome"
            />
          </div>

          <div>
            <label for="phone" class="block text-gray-800 mb-2 font-medium">
              Telefone <span class="text-red-600">*</span>
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              required
              class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--color-bondi-blue)] focus:border-transparent"
              placeholder="(31) 99999-9999"
            />
          </div>

          <div>
            <label for="email" class="block text-gray-800 mb-2 font-medium">
              Email <span class="text-red-600">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--color-bondi-blue)] focus:border-transparent"
              placeholder="seu@email.com"
            />
          </div>

          <div>
            <label for="address" class="block text-gray-800 mb-2 font-medium">
              Endereço
            </label>
            <input
              type="text"
              id="address"
              name="address"
              class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--color-bondi-blue)] focus:border-transparent"
              placeholder="Rua, número, bairro, cidade e CEP"
            />
          </div>

          <div>
            <label for="message" class="block text-gray-800 mb-2 font-medium">
              Deixe aqui sua mensagem <span class="text-red-600">*</span>
            </label>
            <textarea
              id="message"
              name="message"
              required
              rows="5"
              class="w-full px-4 py-3 bg-gray-50 border border-gray-300 rounded-lg text-gray-900 placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-[var(--color-bondi-blue)] focus:border-transparent resize-none"
              placeholder="Conte-nos sobre sua mudança: origem, destino, tipo (residencial/comercial), data aproximada..."
            ></textarea>
          </div>

          {TURNSTILE_SITE_KEY && (
            <div class="cf-turnstile" data-sitekey={TURNSTILE_SITE_KEY} id="turnstile-orcamento"></div>
          )}

          <div id="form-message" class="hidden p-4 rounded-lg text-base font-medium"></div>

          <Button variant="primary" size="lg" class="w-full" type="submit">
            Quero um orçamento
          </Button>

          <p class="text-center text-sm text-gray-600">
            Ou fale conosco pelo <a href={`https://wa.me/${CONTACT.whatsapp}`} target="_blank" rel="noopener noreferrer" class="text-[var(--color-bondi-blue)] hover:underline font-medium">WhatsApp</a>
          </p>
        </form>
      </div>

      <div class="mt-8 text-center">
        <a href="/" class="inline-flex items-center justify-center px-6 py-3 rounded-lg font-medium bg-white text-gray-900 border-2 border-white shadow-lg hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-[var(--color-dark-blue)] transition-colors">
          ← Voltar
        </a>
      </div>
    </div>
  </section>
</BaseLayout>

<script>
  import emailjs from '@emailjs/browser';
  import { CONTACT } from '../utils/constants';

  const EMAILJS_SERVICE_ID = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID || '';
  const EMAILJS_TEMPLATE_ID = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID || '';
  const EMAILJS_PUBLIC_KEY = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY || '';
  const TURNSTILE_SITE_KEY = import.meta.env.PUBLIC_TURNSTILE_SITE_KEY || '';

  if (EMAILJS_PUBLIC_KEY) {
    emailjs.init(EMAILJS_PUBLIC_KEY);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form');
    if (!form) return;

    const phoneInput = form.querySelector('#phone') as HTMLInputElement | null;
    const emailInput = form.querySelector('#email') as HTMLInputElement | null;

    const formatPhoneBR = (value: string): string => {
      const digits = value.replace(/\D/g, '').slice(0, 11);
      if (digits.length <= 2) return digits;
      if (digits.length <= 6) return `(${digits.slice(0, 2)}) ${digits.slice(2)}`;
      if (digits.length <= 10) {
        return `(${digits.slice(0, 2)}) ${digits.slice(2, 6)}-${digits.slice(6)}`;
      }
      return `(${digits.slice(0, 2)}) ${digits.slice(2, 7)}-${digits.slice(7)}`;
    };

    if (phoneInput) {
      phoneInput.addEventListener('input', (event) => {
        const target = event.target as HTMLInputElement;
        target.value = formatPhoneBR(target.value);
      });
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('form-message');
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;

      const formData = new FormData(form);

      const templateParams = {
        from_name: formData.get('name'),
        from_phone: formData.get('phone'),
        from_email: formData.get('email'),
        from_address: formData.get('address') || '',
        message: formData.get('message'),
        to_email: CONTACT.email,
      };

      // Honeypot: se preenchido, é bot — não envia (retorna em silêncio)
      if (formData.get('company_website')) return;

      // Validação simples de email
      const email = String(formData.get('email') || '').trim();
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) {
        if (messageDiv) {
          messageDiv.className =
            'p-4 rounded-lg bg-red-100 border-2 border-red-700 text-red-900 text-base font-medium';
          messageDiv.textContent = 'Insira um email válido.';
          messageDiv.classList.remove('hidden');
        }
        if (emailInput) emailInput.focus();
        return;
      }

      if (!EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID || !EMAILJS_PUBLIC_KEY) {
        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg bg-amber-100 border-2 border-amber-600 text-amber-900 text-base font-medium';
          messageDiv.innerHTML = `Formulário não configurado. Envie sua mensagem pelo <a href="https://wa.me/${CONTACT.whatsapp}" target="_blank" rel="noopener" class="underline font-medium">WhatsApp</a> ou para ${CONTACT.email}`;
          messageDiv.classList.remove('hidden');
        }
        return;
      }

      // Turnstile: exige verificação quando a chave está configurada
      if (TURNSTILE_SITE_KEY) {
        const turnstileResponse = (form.querySelector('[name="cf-turnstile-response"]') as HTMLInputElement | HTMLTextAreaElement)?.value;
        if (!turnstileResponse || !turnstileResponse.trim()) {
          if (messageDiv) {
            messageDiv.className = 'p-4 rounded-lg bg-amber-100 border-2 border-amber-600 text-amber-900 text-base font-medium';
            messageDiv.textContent = 'Complete a verificação antes de enviar.';
            messageDiv.classList.remove('hidden');
          }
          return;
        }
      }

      if (submitButton) {
        submitButton.disabled = true;
        (submitButton as HTMLButtonElement).innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
      }
      if (messageDiv) messageDiv.classList.add('hidden');

      try {
        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg bg-green-100 border-2 border-green-700 text-green-900 text-base font-medium';
          messageDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Mensagem enviada! Retornaremos em breve.';
          messageDiv.classList.remove('hidden');
        }
        form.reset();

        if (TURNSTILE_SITE_KEY && typeof window !== 'undefined' && (window as any).turnstile) {
          try { (window as any).turnstile.reset(); } catch (_) {}
        }
      } catch (err) {
        console.error('EmailJS error:', err);
        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg bg-red-100 border-2 border-red-700 text-red-900 text-base font-medium';
          messageDiv.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>Erro ao enviar. Tente pelo <a href="https://wa.me/${CONTACT.whatsapp}" target="_blank" rel="noopener" class="underline font-medium">WhatsApp</a>.`;
          messageDiv.classList.remove('hidden');
        }
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          (submitButton as HTMLButtonElement).innerHTML = 'Quero um orçamento';
        }
      }
    });
  });
</script>
