---
import BaseLayout from '../layouts/BaseLayout.astro';
import Logo from '../components/ui/Logo.astro';
import Button from '../components/ui/Button.astro';
import { SERVICES } from '../utils/constants';

const url = new URL(Astro.request.url);
const planParam = url.searchParams.get('plan') || 'starter';
const selectedPlan = planParam === 'business' ? SERVICES.BUSINESS : SERVICES.STARTER;
---

<BaseLayout 
  title="Get Started - Axory Studio | Submit Your Project"
  description="Submit your project details to get started with Axory Studio. We'll review your project and get back to you within 24 hours."
  canonical="https://axory.dev/form"
>
  <div class="pt-20 pb-20 bg-[var(--color-background-dark)]">
    <div class="container mx-auto px-6 py-12 max-w-3xl">
      <div class="text-center mb-12">
        <Logo variant="full" class="h-12 mx-auto mb-6" />
        <h1 class="text-4xl md:text-5xl font-bold mb-4 text-[var(--color-platinum)]">
          Let's Get Started
        </h1>
        <p class="text-[var(--color-platinum)]/70 text-lg">
          Tell us about your project and we'll get back to you within 24 hours
        </p>
      </div>

      <div class="bg-[var(--color-background)] rounded-lg p-8 border border-[var(--color-platinum)]/10">
        <div class="mb-6 p-4 bg-[var(--color-indigo-velvet)]/20 rounded-lg border border-[var(--color-indigo-velvet)]/30">
          <p class="text-sm text-[var(--color-platinum)]/80 mb-2">Selected Plan:</p>
          <p class="text-xl font-semibold text-[var(--color-platinum)]">{selectedPlan.name}</p>
          <p class="text-sm text-[var(--color-platinum)]/70 mt-1">
            ${selectedPlan.priceRange.min} - ${selectedPlan.priceRange.max}
          </p>
        </div>

        <form id="contact-form" class="space-y-6">
          <input type="hidden" name="plan" value={selectedPlan.name} />
          
          <div>
            <label for="name" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Full Name <span class="text-red-400">*</span>
            </label>
            <input
              type="text"
              id="name"
              name="name"
              required
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
              placeholder="John Doe"
            />
          </div>

          <div>
            <label for="email" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Email <span class="text-red-400">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
              placeholder="john@example.com"
            />
          </div>

          <div>
            <label for="company" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Company Name
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
              placeholder="Your Company"
            />
          </div>

          <div>
            <label for="phone" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Phone Number
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
              placeholder="+1 (555) 123-4567"
            />
          </div>

          <div>
            <label for="description" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Project Description <span class="text-red-400">*</span>
            </label>
            <textarea
              id="description"
              name="description"
              required
              rows="6"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent resize-none"
              placeholder="Tell us about your project, goals, and any specific requirements..."
            ></textarea>
          </div>

          <div>
            <label for="budget" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Budget Range (Optional)
            </label>
            <select
              id="budget"
              name="budget"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
            >
              <option value="">Select budget range</option>
              <option value="$249 - $349">$249 - $349</option>
              <option value="$499 - $799">$499 - $799</option>
              <option value="$800+">$800+</option>
              <option value="Custom">Custom</option>
            </select>
          </div>

          <div>
            <label for="timeline" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Expected Launch Date (Optional)
            </label>
            <input
              type="date"
              id="timeline"
              name="timeline"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent"
            />
          </div>

          <div>
            <label for="requirements" class="block text-[var(--color-platinum)] mb-2 font-medium">
              Special Requirements or Questions
            </label>
            <textarea
              id="requirements"
              name="requirements"
              rows="4"
              class="w-full px-4 py-3 bg-[var(--color-background-dark)] border border-[var(--color-platinum)]/20 rounded-lg text-[var(--color-platinum)] focus:outline-none focus:ring-2 focus:ring-[var(--color-indigo-velvet)] focus:border-transparent resize-none"
              placeholder="Any additional information or questions..."
            ></textarea>
          </div>

          <div id="form-message" class="hidden p-4 rounded-lg mb-4"></div>

          <Button variant="primary" size="lg" class="w-full" type="submit">
            Submit Project Details
          </Button>

          <p class="text-center text-sm text-[var(--color-platinum)]/60">
            We'll review your project and get back to you within 24 hours
          </p>
        </form>
      </div>

      <div class="mt-8 text-center">
        <Button href="/" variant="outline">
          ‚Üê Back to Home
        </Button>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import emailjs from '@emailjs/browser';

  // Get EmailJS config from environment variables
  const EMAILJS_SERVICE_ID = import.meta.env.PUBLIC_EMAILJS_SERVICE_ID || '';
  const EMAILJS_TEMPLATE_ID = import.meta.env.PUBLIC_EMAILJS_TEMPLATE_ID || '';
  const EMAILJS_PUBLIC_KEY = import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY || '';

  // Initialize EmailJS
  if (EMAILJS_PUBLIC_KEY) {
    emailjs.init(EMAILJS_PUBLIC_KEY);
  }

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form');
    if (!form) return;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const messageDiv = document.getElementById('form-message');
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      if (!EMAILJS_SERVICE_ID || !EMAILJS_TEMPLATE_ID || !EMAILJS_PUBLIC_KEY) {
        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg mb-4 bg-yellow-500/20 border border-yellow-500/50 text-yellow-400';
          messageDiv.textContent = 'EmailJS is not configured. Please set environment variables.';
          messageDiv.classList.remove('hidden');
        }
        return;
      }
      
      // Show loading state
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';
      }
      
      if (messageDiv) {
        messageDiv.classList.add('hidden');
      }
      
      try {
        const formData = new FormData(form);
        const templateParams = {
          from_name: formData.get('name'),
          from_email: formData.get('email'),
          company: formData.get('company') || 'Not provided',
          phone: formData.get('phone') || 'Not provided',
          plan: formData.get('plan'),
          description: formData.get('description'),
          budget: formData.get('budget') || 'Not specified',
          timeline: formData.get('timeline') || 'Not specified',
          requirements: formData.get('requirements') || 'None',
        };

        await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
        
        // Success
        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg mb-4 bg-green-500/20 border border-green-500/50 text-green-400';
          messageDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Thank you! We\'ll review your project and get back to you within 24 hours.';
          messageDiv.classList.remove('hidden');
        }
        form.reset();
        
      } catch (error) {
        console.error('EmailJS error:', error);
        if (messageDiv) {
          messageDiv.className = 'p-4 rounded-lg mb-4 bg-red-500/20 border border-red-500/50 text-red-400';
          messageDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>Something went wrong. Please try again or contact us directly via WhatsApp.';
          messageDiv.classList.remove('hidden');
        }
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.innerHTML = 'Submit Project Details';
        }
      }
    });
  });
</script>
